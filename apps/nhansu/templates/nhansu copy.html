<title id="title">Nhân sự | TCCB - USSH</title>

<div id="boder" class="basis-full shrink bg-gray-50 overflow-y-hidden overflow-x-hidden flex flex-col justify-start items-center">
    <div id="container" 
    x-data="{
        search: '',
        dataframe: [],
        isLoading: false,
        getSearchResults() {
            return miniSearch.search(this.search).map(({ id }) => resultbyid[id])
        },
        getSuggestions() {
            return miniSearch.autoSuggest(query)
              .filter(({ suggestion, score }, _, [first]) => score > first.score / 4)
              .slice(0, 5)
        },
        async getData() {
            const miniSearch = new MiniSearch({
              fields: ['maso', 'hovaten', 'ngaysinh'],
              searchOptions: {
                fuzzy: 0.2
              }
            })
            this.isLoading = true;
            fetch('/api/nhansu/search')            
                .then((response) => response.json())
                .then((data) => { 
                    this.dataframe = data;
                    this.isLoading = false;
                    miniSearch.addAll(data)
                });
        }
    }"
    x-init="getData()"
    class="overflow-auto w-full h-full flex flex-col justify-start items-center px-[30px] py-[15px]">
        <div class="w-full flex flex-row justify-between items-end shrink-0">

            {# Trang chủ/nhân sự #}
            <div class="w-[150px] flex flex-col justify-start items-start">
                <div class="text-[22px] font-[600] mb-[5px]">Nhân sự</div>
                <div class="text-[15px] font-[600]">Trang chủ / <span class="font-[500]">Nhân sự</span></div>
            </div>
            {# End Trang chủ/nhân sự #}


            {# Search #}
            <div class="shadow w-[500px] h-[50px] rounded-3xl bg-white flex flex-row justify-start items-center">
                <div class="basis-[50px] shrink-0 rounded-full">
                    <i class="fa-solid fa-magnifying-glass text-[14px] text-gray-400"></i>
                </div>
                <input x-model="search"
                class="p-0 rounded-r-3xl basis-[87%] shrink text-[16px] border-transparent focus:border-transparent focus:ring-0" 
                type="search">
            </div>
            {# End search #}


            {# Điều chỉnh #}
            <div class="w-[150px] flex flex-row justify-end items-center">
                <div x-data 
                @click="$dispatch('modify')"
                class="bg-[#fd7279] active:bg-[#d96268] text-white text-[12px] font-[500] px-[15px] py-[8px] rounded-3xl flex justify-center items-center gap-2 cursor-pointer">
                    <i class="fa-solid fa-gear"></i>
                    <div>Điều chỉnh</div>
                </div>
            </div>
            {# End Điều chỉnh #}
            

            {# download/upload #}
            <div x-data="{open: false}" @modify.window="open = ! open" class="fixed left-0 top-0 z-[2000]">
                <div x-show="open" 
                @click="open = ! open; $dispatch('closepopup'); htmx.trigger('#upload-form', 'htmx:abort')" 
                @keyup.escape.window="open = ! open; $dispatch('closepopup'); htmx.trigger('#upload-form', 'htmx:abort')" 
                class="w-screen h-screen bg-black opacity-85"></div>
                <div x-show="open" class="rounded-xl overflow-hidden fixed top-[50%] translate-y-[-50%] left-[50%] translate-x-[-50%] w-[500px] h-[400px] bg-white opacity-100">
                    <div id="form" 
                    hx-trigger="modify from:body"
                    hx-get="/template/nhansu/form/upload"
                    hx-ext="alpine-morph"
                    hx-swap="multi:#form:morph"
                    class="w-full h-full flex justify-center items-center">
                        <div class="htmx-indicator flex flex-col gap-6 w-[400px]">
                            <div class="skeleton h-32 w-full"></div>
                            <div class="skeleton h-4 w-28"></div>
                            <div class="skeleton h-4 w-full"></div>
                            <div class="skeleton h-4 w-full"></div>
                        </div>
                    </div>
                </div>
            </div>
            {# End download/upload #}

        </div>


        {# Hashtags #}
        <div id="hashtags" class="z-[2] w-full h-auto mb-[15px] flex flex-row justify-center items-start">
            <div x-data="{
                focusinput: false,
                showoptions: false,
                items: ['banana','bababa','bahaha','mango','apple','orange','chili','lemon','sdfsfssfdsfs','wetrtwrfggsferwete','ghtyutyutyesrtedfsrw'],
                results: [],
                search: '',
                research: '',
                backspace: true,
                choose: 0,
                get filteredItems() {
                    if (this.search !== '') {
                        return this.items.filter(
                            i => i.startsWith(this.search)
                        )
                    } else {
                        return []
                    }
  
                },
                get checkresults() {
                    return this.results.length === 0
                },
                addItem(value) {
                    console.log(value);
                    this.items = this.items.filter(i => i !== value);
                    this.results.push(value); 
                    this.search = '';
                    this.showoptions = false;
                },
                removeItem(value) {
                    console.log(value);
                    this.results = this.results.filter(i => i !== value);
                    this.items.push(value);
                },
                checkItem() {
                    if (this.filteredItems.length == 0) {
                        this.search = ''
                    }     
                },
                enterEvent() {
                    if (typeof this.filteredItems[this.choose] !== 'undefined') {
                        this.addItem(this.filteredItems[this.choose])
                    } else {
                        this.search = ''
                    }
                },
                eventBackspace() {
                    this.backspace = true;
                },
                checkdown() {
                    if (this.backspace === true) {
                        this.research = this.search;
                        this.backspace = false;
                        if (this.research === '' && this.results.length > 0) {
                            value = this.results.at(-1);
                            this.results = this.results.filter(i => i !== value);
                            this.items.push(value);
                     
                        }
                    }
                },
                showoptionscheck(e) {
                    if (e.keyCode == 32 || e.keyCode == 189 || (e.keyCode >= 48 && e.keyCode <= 90) || (e.keyCode >= 96 && e.keyCode <= 105)) {
                        this.choose = 0;
                    }
                    if (this.search !== '' && this.focusinput == true) {
                        this.showoptions = true;
                    } else {
                        this.showoptions = false;
                    }
                },
                focusinputcheck() {
                    this.focusinput = true;
                    if (this.search !== '') {
                        this.showoptions = true;
                    }
                },
                checkchoose(index) {
                    return index === this.choose
                },
                selectoption(type) {
                    if (type === 'up' && this.choose > 0) {
                        this.choose = this.choose - 1
                    } else if (type === 'down' && this.choose < (this.filteredItems.length - 1)) {
                        this.choose = this.choose + 1
                    }
                }
            }"
            class="w-[600px]"
            @click.outside="focusinput = false; showoptions = false;">

                <div x-ref="divinput"

                class="relative rounded-lg w-full flex flex-row justify-center items-start flex-wrap py-[8px] px-[15px] gap-2">
                        {# <i class="absolute top-[10px] left-[5px] text-gray-300 text-[20px] fa-solid fa-hashtag"></i> #}
                        <div :class="checkresults ? 'bg-[#ff4b4b]' : 'bg-gray-400'"
                        class="text-[13px]  rounded-md text-white px-[10px] py-[2px] cursor-default flex flex-row items-center relative">
                            <div># Tất cả</div>
                        </div>
                    <template x-for="result in results" :key="result">
                        <div class="text-[13px] bg-[#ff4b4b] rounded-md text-white px-[10px] py-[2px] cursor-default flex flex-row items-center relative">
                            <div x-text="'# ' + result"></div>
                            <i @click="removeItem(result)"
                            class="fa-solid fa-xmark cursor-pointer pl-[10px]"></i>
                        </div>
                    </template>
                    <div class="rounded-lg border border-orange overflow-hidden relative px-[10px] min-w-[100px] w-auto max-w-[100%] h-[25px] flex flex-row justify-start">
                        <span x-text="search + 'a'" 
                        x-ref="span" 
                        class="invisible text-[14px] p-0"></span>
                        <input type="text" 
                        placeholder="Nhập tag..."
                        @click.outside="checkItem()"
                        @keyup.enter="enterEvent()"
                        @keydown.up.prevent.throttle.100ms="selectoption('up')"
                        @keydown.down.prevent.throttle.100ms="selectoption('down')"
                        @keyup.up.prevent
                        @keyup.down.prevent
                        class="w-[100%] absolute px-[10px] left-0 text-[14px] py-[5px] border-transparent focus:border-transparent focus:ring-0 top-[50%] translate-y-[-50%]"
                        x-ref="input"
                        x-model="search"
                        @focus="focusinputcheck()"
                        @keydown.backspace="checkdown()"
                        @keyup = 'showoptionscheck'
                        @keyup.backspace="eventBackspace"/>
                    </div>
                </div>

                <div x-show="showoptions" x-anchor.bottom="$refs.input">
                    <ul class="shadow-xl bg-white rounded-lg w-[300px] h-auto flex flex-col overflow-hidden">
                        <template x-if="filteredItems.length === 0">
                            <li class="w-full text-gray-400 cursor-default py-[10px] px-[20px]">Không tìm thấy kết quả nào</li>
                        </template>
                        <template x-for="(item, index) in filteredItems" :key="item">
                            <li x-text="item"
                            @click="addItem(item)"
                            @mouseover="choose = index"
                            :class="checkchoose(index) ? 'bg-gray-100' : ''"
                            class="text-left w-full cursor-pointer py-[10px] px-[20px]"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
        {# End Hashtags #}


        {# Table #}
        <div id="table" class="z-[1] shadow-lg relative rounded-lg w-full basis-full shrink max-w-[1000px] flex flex-col justify-start items-cen text-left">
            <!-- head of table -->
            <div id="thead" 
            class="sticky top-[-15px] w-full min-w-[750px] flex flex-row bg-gray-200 text-black font-[700] rounded-t-lg">
                <div class="w-[5%] min-w-[50px] flex flex-row justify-start items-center">
                    <div class="p-[15px]">#</div>
                </div>
                <div class="w-[15%] min-w-[100px] flex flex-row justify-start items-center">
                    <div class="py-[15px]">MSCB</div>
                </div>
                <div class="w-[25%] min-w-[200px] flex flex-row justify-start items-center">
                    <div class="py-[15px]">Họ và tên</div>
                </div>
                <div class="w-[20%] min-w-[100px] flex flex-row justify-start items-center">
                    <div class="py-[15px]">Ngày sinh</div>
                </div>
                <div class="w-[25%] min-w-[220px] flex flex-row justify-start items-center">
                    <div class="py-[15px]">Đơn vị</div>
                </div>
                <div class="w-[10%] min-w-[80px] flex flex-row justify-center items-center">
                    <div class="py-[15px]">@</div>
                </div>
            </div>
            <!-- end head of table -->            
        
            <!-- body of table -->
            <div id="tbody" 
            x-show="! isLoading"
            class="bg-white max-w-[1000px] rounded-b-lg flex flex-col w-auto justify-start items-start">
                <template x-for="(item, index) in dataframe" :key="index">
                    <div id="trow" class="hover:bg-gray-100 cursor-default rounded-b-lg w-full min-w-[750px] flex flex-row bg-white font-[500]">
                        {# index #}
                        <div class="w-[5%] min-w-[50px] flex flex-row justify-start items-center font-[400]">
                            <div x-text="index + 1" class="py-[10px] px-[15px]"></div>
                        </div>
                        {# end index #}

                        {# maso #}
                        <div class="w-[15%] min-w-[100px] flex flex-row justify-start items-center">
                            <div x-text="item.maso" class="py-[10px]"></div>
                        </div>
                        {# end maso #}

                        {# hovaten #}
                        <div class="w-[25%] min-w-[200px] flex flex-row justify-start items-center">
                            <div x-text="item.hovaten" class="py-[10px]"></div>
                        </div>
                        {# end hovaten #}

                        {# ngaysinh #}
                        <div class="w-[20%] min-w-[100px] flex flex-row justify-start items-center font-[400]">
                            <div x-text="item.ngaysinh" class="py-[10px]"></div>
                        </div>
                        {# end ngaysinh #}

                        {# donvi #}
                        <div class="w-[25%] min-w-[220px] flex flex-row justify-start items-center font-[400]">
                            <div class="py-[10px]">Khoa Ngữ văn Tây Ban Nha - Italia</div>
                        </div>
                        {# end donvi #}

                        {# button hoso #}
                        <div class="w-[10%] min-w-[80px] flex flex-row justify-center items-center font-[400]">
                            <div class="hover:bg-green rounded-2xl border-2 border-green px-[10px] py-[2px] font-[500] cursor-pointer">Hồ sơ</div>
                        </div>
                        {# end button hoso #}
                    </div>
                </template>
            </div>
            <!-- end body of table -->

            {# skeleton #}
            <div x-show="isLoading"
            class="mt-[20px] relative w-full flex flex-col gap-8">
                <div class="skeleton h-32 w-full"></div>
                <div class="skeleton h-4 w-28"></div>
                <div class="skeleton h-4 w-full"></div>
                <div class="skeleton h-4 w-full"></div>
            </div>
            {# end skeleton #}

        </div>
        {# End Table #}

    </div>  
</div>